<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="Mixdiffpools.css">
    <title>NextSeq2000-loading-scheme</title>
</head>
<body onload="displayDate()">

<header class="header">
    <a href="Mixdiffpools.html" class="logo">
        <img src="Pictures/Wur.png" alt="logo">
    </a>

    <nav class="navbar">
        <a href="Mixdiffpools.html">Mix diff pools</a>
        <a href="NLP.html">NLP</a>
        <a href="Database.html">Database</a>
        <a href="#">Calculation</a>
    </nav>
</header>

<div class="content">
    <form action="process_form.php" method="POST" id="combinedForm">
        <div class="form-wrapper">
            <!-- Form Section -->
            <div class="form-container">
                <label for="project">projectPool</label>
                <input type="text" id="project" name="project" placeholder="Voer hier het projectPool nummer" required onblur="prependNGS()">

                <label for="application">Kies een optie:</label>
                <select id="application" name="application" required>
                    <option value="WGS">WGS</option>
                    <option value="RNAseq">RNAseq</option>
                    <option value="MGX">MGX</option>
                    <option value="Amplicon">Amplicon</option>
                </select>

                <label for="size">genomeSize</label>
                <input type="text" id="size" name="size" placeholder="Voer hier het genomeSize in" required>

                <label for="coverage">coverage/depth</label>
                <input type="text" id="coverage" name="coverage" placeholder="Voer hier de coverage/depth in" required>

                <label for="sampleCount">sampleCount</label>
                <input type="text" id="sampleCount" name="sampleCount" placeholder="Voer hier de sampleCount in" required>

                <label for="conc">conc</label>
                <input type="text" id="conc" name="conc" placeholder="Voer hier de conc in" pattern="\d{1,2}(,\d{1,2})?" title="Maximaal 2 getallen voor de komma en maximaal 2 getallen na de komma." required>

                <label for="avgLibSize">avgLibSize</label>
                <input type="text" id="avgLibSize" name="avgLibSize" placeholder="Voer hier de avgLibSize in" required>

                <label for="cycli">cycli</label>
                <select id="cycli" name="cycli" required>
                    <option value="300" selected>300</option>
                    <option value="600">600</option>
                </select>

                <button type="button" onclick="performCalculationsAndSubmit()">Calculate & Submit</button>
            </div>

            <!-- Table Section -->
            <div class="form-container">
                <table id="projectTable" border="1" cellspacing="0" cellpadding="10">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>ProjectPool</th>
                            <th>Clusters</th>
                            <th>nM</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be dynamically added here -->
                    </tbody>
                </table>
                <button type="button" onclick="calculateFlowcellForSelected()">Calculate Flowcell for Selected</button>
            </div>
        </div>
    </form>
</div>

<script>
    const projectTableBody = document.querySelector("#projectTable tbody");

    function prependNGS() {
        var projectField = document.getElementById('project');
        if (!projectField.value.startsWith("NGS-")) {
            projectField.value = "NGS-" + projectField.value;
        }
    }

    function performCalculationsAndSubmit() {
        const project = document.getElementById('project').value;
        const application = document.getElementById('application').value;
        const size = parseFloat(document.getElementById('size').value);
        const coverage = parseFloat(document.getElementById('coverage').value);
        const sampleCount = parseFloat(document.getElementById('sampleCount').value);
        const cycli = parseInt(document.getElementById('cycli').value);
        const conc = parseFloat(document.getElementById('conc').value.replace(',', '.'));
        const avgLibSize = parseFloat(document.getElementById('avgLibSize').value);

        const factor1 = (cycli === 300) ? 270 : 450;
        let clusters;

        switch (application) {
            case "WGS":
                clusters = (size * coverage * sampleCount) / factor1;
                break;
            case "RNAseq":
            case "Amplicon":
            case "MGX":
                clusters = coverage * sampleCount;
                break;
            default:
                clusters = 0;
        }

        clusters = clusters.toExponential(2);

        const nM = (conc * 1000) / (649 * avgLibSize) * 1000;

        // Insert data into the database
        fetch('process_form.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                project,
                application,
                size,
                coverage,
                sampleCount,
                conc,
                avgLibSize,
                cycli,
                clusters,
                nM
            })
        })
        .then(response => response.text())
        .then(data => {
            alert('Data submitted successfully');
            addRowToTable(project, clusters, nM.toFixed(1));
        })
        .catch(error => console.error('Error:', error));
    }

    function addRowToTable(project, clusters, nM) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="checkbox" class="row-select"></td>
            <td>${project}</td>
            <td>${clusters}</td>
            <td>${nM}</td>
        `;
        projectTableBody.appendChild(row);
    }

    function calculateFlowcellForSelected() {
        const rows = document.querySelectorAll('#projectTable tbody tr');
        let totalClusters = 0;

        rows.forEach(row => {
            const checkbox = row.querySelector('.row-select');
            if (checkbox.checked) {
                const clusters = parseFloat(row.cells[2].textContent);
                totalClusters += clusters;
            }
        });

        const flowcellOptions = [
            { name: "P1", maxClusters: 100000000 },
            { name: "P2", maxClusters: 400000000 },
            { name: "P3", maxClusters: 1200000000 },
            { name: "P4", maxClusters: 1800000000 }
        ];

        const selectedFlowcell = flowcellOptions.find(option => totalClusters <= option.maxClusters);

        if (selectedFlowcell) {
            alert(`Selected Flowcell: ${selectedFlowcell.name}`);
        } else {
            alert("The total clusters exceed the capacity of all available flowcells.");
        }
    }

    let lastScrollTop = 0; // Houdt de laatste scrollpositie bij
    const navbar = document.querySelector('.header'); // Selecteer de navbar

    window.addEventListener('scroll', () => {
        const currentScroll = window.pageYOffset || document.documentElement.scrollTop;

        if (currentScroll > lastScrollTop) {
            // Naar beneden scrollen - verberg de navbar
            navbar.style.top = "-100px"; // Verberg de navbar buiten het scherm
        } else {
            // Naar boven scrollen - toon de navbar
            navbar.style.top = "0";
        }

        lastScrollTop = currentScroll <= 0 ? 0 : currentScroll; // Zorg ervoor dat de waarde niet negatief wordt
    });
</script>
</body>
</html>
